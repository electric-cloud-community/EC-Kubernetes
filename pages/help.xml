<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta content="text/html; charset=us-ascii" http-equiv="content-type"/>
        <title>EC-Kubernetes Plugin</title>
		<link rel="stylesheet" href="../../plugins/@PLUGIN_NAME@/pluginhelp.css" type="text/css" media="screen"/>
    </head>
    <body>
        <div class="help">
            <h1>EC-Kubernetes</h1>
            <p>Plugin version @PLUGIN_VERSION@</p>
            <hr style="margin-left: -10px; margin-top: 10px; height: 1px; width: 100%; color: #5981BD;" noshade="noshade"/>
            <h3>Overview</h3>
            <p>EC-Kubernetes plugin integrates with the kubernetes cluster to run Docker containers. Kubernetes schedules your containers into the cluster and manages them automatically based on requirements you define (such as CPU and memory).

            You need to have a Kubernetes cluster available for using this plugin.
            </p>
            <h1>Contents</h1>
            <ul>
                <li><a href="#overview">Overview</a></li>
                <li><a href="#CreateConfiguration">Plugin Configuration</a></li>
                 <li><a href="#procedures">Plugin Procedures</a></li>
                <ul>
                    <li><a href="#ProvisionCluster">Check Cluster</a></li>
                    <li><a href="#DeployService">Deploy Service</a></li>
                    <li><a href="#UndeployService">Undeploy Service</a></li>
                    <li><a href="#CreateOrUpdateKubernetesResource">Invoke Kubernetes API</a></li>
                </ul>
                <li><a href="#usecases">Use Cases</a></li>
                <ul>
                    <li><a href="#RollingUpdates">Rolling Updates</a></li>
                    <li><a href="#CanaryDeployments">Canary Deployments</a></li>
                    <li><a href="#BlueGreenDeployments">Blue/Green Deployments</a></li>
                </ul>
                <li><a href="#releaseNotes">Release Notes</a></li>
            </ul>
            <div id="CreateConfiguration">
                <a name='CreateConfiguration' id="CreateConfiguration"> </a>
                <h2>Plugin Configurations</h2>
                <!-- If the plugin has separate configurations then include
                     this section, otherwise omit this whole section. We don't
                     need to have a configuration section that just says "There
                     is no configuration for this plugin." -->
                <p>
                    Plugin configurations are sets of parameters that apply
                    across some or all of the plugin procedures. They
                    reduce repetition of common values, create
                    predefined parameter sets for end users, and
                    securely store credentials where needed. Each configuration
                    is given a unique name that is entered in designated
                    parameters on procedures that use them.<br /><br />
                </p>
                <!-- For all parameters, the parameter name should be *exactly*
                     the same as it appears in the Parameter Panel, and the first
                     sentence(s) of the description should be the same as the tooltip (if
                     there is one). After that, the parameter description can go into
                     greater detail about the parameter including valid value ranges and
                     examples. -->
                <h3>Creating Plugin Configurations</h3>
                <p>To create plugin configurations in ElectricFlow,
                do these steps:</p>
                
                <li>Go to <b>Administration</b> &gt; <b>Plugins</b> to open the Plugin Manager.</li>
                    <li>Find the EC-Kubernetes row.</li>
                    <li>Click <b>Configure</b> to open the
                    Kubernetes Configurations page.</li>
                    <li>Click <b>Create Configuration</b>.</li>
                    <li>For communicating with the Kubernetes cluster, you need the following details:<br/>
                    <ul type="square">
                        <li>1. Base address of API Endpoint URL </li>
                        <li>2. Bearer token which has authorization to access API.  
                        <p>Use the following steps for creating a bearer token:</p>
                        <ul>
                            <li>Download the Kubeconfig file from your Kubernetes cluster. Or if you have direct access to Kubectl shell of the cluster, that will work too.</li>
                            <li>You will need to install Kubectl (http://kubernetes.io/docs/user-guide/prereqs/) or have access to Kubectl shell</li>
                            <li>Create a service account with following kubectl command:<p>
                                kubectl create serviceaccount api-user
                            </p></li>
                            <li>Assign cluster-admin role to serviceaccount api-user. Specify serviceaccount name as default:api-user, if it is created in default namespace.
                                <p>kubectl create clusterrolebinding root-cluster-admin-binding --clusterrole=cluster-admin --serviceaccount=default:api-user</p>
                            </li>
                            <li>Get details of the service account we just created, from the output determine name of secret in which data is stored:<p>
                            kubectl get serviceaccount api-user -o yaml
                            </p></li>
                            <li>Assuming name of secret from above step is secret-1234, get details of secret:
                                <p>kubectl get secret secret-1234 -o yaml</p></li>
                                <li>The value of token field in above output is the berar token in encoded format. We need to decode it and use it as berar token. On a Unix like system, following command will decode the password<p>
                                echo "encoded_string" | base64 --decode
                                </p></li>
                        </ul>
                        </li>
                    </ul>
                </li>

            </div>            
            <h1 id="procedures">Plugin Procedures</h1>
            <p>
                IMPORTANT: For all parameter descriptions below, required parameters are shown in
                <span class="required">bold italics</span>. Please note that some of names given in ElectricFlow UI will be modified to comply with the naming conventions of Kubernetes. Specifically characters such as "space , _ " will be converted to "-". Such parameters are marked with an asterisk (*).
            </p>
            <div id="ProvisionCluster">
                <h2>Check Cluster</h2>
                <p>The procedure checks if the cluster exists and is reachable with provided details.</p>
                <h3>Check Cluster Parameters</h3>
                <table class="grid">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="required">Configuration</td>
                            <td>The name of an existing configuration which holds all the connection information for the Kubernetes cluster.</td>
                        </tr>

                    </tbody>
                </table>
            </div>  
            <div id="DeployService">
                <h2>Deploy Service</h2>
                <p>This procedure deploys a service to a Kubernetes cluster</p>
                <h3>Deploy Service Parameters</h3>
                <table class="grid">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="required">Service Name</td>
                            <td>The name of the service in ElectricFlow that encapsulates the service to be deployed on the Kubernetes cluster.</td>
                        </tr>
                        <tr>
                            <td>Service Revision ID</td>
                            <td>Revision Id of the service in ElectricFlow.</td>
                        </tr>
                        <tr>
                            <td class="required">Project Name</td>
                            <td>The name of the project that the service belongs to. In case of an application-level service it also owns the application.</td>
                        </tr>
                        <tr>
                            <td>Application Name</td>
                            <td>The name of the application that the service belongs to. Not applicable for a top-level service.</td>
                        </tr>
                        <tr>
                            <td>Application Revision ID</td>
                            <td>Revision Id of the application version that the service belongs to.</td>
                        </tr>  
                        <tr>
                            <td>Cluster Name</td>
                            <td>The name of the cluster in ElectricFlow that encapsulates the Kubernetes cluster on which the service is to be deployed.</td>
                        </tr>                        
                        <tr>
                            <td>Cluster or environment project name</td>
                            <td>The name of the project that the cluster belongs to if it is a top-level project cluster. Or the name of the project that the environment belongs to if it is an environment-scoped cluster.</td>
                        </tr>
                        <tr>
                            <td>Environment Name</td>
                            <td>The name of the environment that the cluster belongs to. Not applicable for a top-level project cluster.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="UndeployService">
                <h2>Undeploy Service</h2>
                <p>Undeploys a previously deployed service on the Kubernetes cluster</p>

                <h3>Undeploy Service Parameters</h3>
                <table class="grid">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>

                        <tr>
                            <td>Application Name</td>
                            <td>The name of the application that the service belongs to. Not applicable for a top-level service.</td>
                        </tr>

                        <tr>
                            <td>Application Revision ID</td>
                            <td>Revision Id of the application version that the service belongs to.</td>
                        </tr>

                        <tr>
                            <td>Cluster Name</td>
                            <td>The name of the cluster in the environment on which the service was previously deployed. If not specified, the application tier mapping will be used to find the cluster name.</td>
                        </tr>

                        <tr>
                            <td class="required">Environment Name</td>
                            <td>The name of the environment that the cluster belongs to.</td>
                        </tr>

                        <tr>
                            <td>Environment Project Name</td>
                            <td>The name of the project that the environment belongs to. If not specified, the environment is assumed to be in the same project as the service.</td>
                        </tr>

                        <tr>
                            <td class="required">Service Name*</td>
                            <td>The name of the service in ElectricFlow that encapsulates the service that was previously deployed on the Kubernetes cluster.</td>
                        </tr>
                        <tr>
                            <td>Service Revision ID</td>
                            <td>Revision Id of the service in ElectricFlow.</td>
                        </tr>
                        <tr>
                            <td class="required">Project Name</td>
                            <td>The name of the project that the service belongs to. In case of an application-level service it also owns the application.</td>
                        </tr>

                    </tbody>
                </table>

            </div>
            <div id="CreateOrUpdateKubernetesResource">
                <h2>Invoke Kubernetes API</h2>
                <p>Invokes Kubernetes REST API based on specified input parameters. Can also be used to create or modify a resource in Kubernetes cluster based on JSON/YAML as input.</p>

                <h3>Invoke Kubernetes API Parameters</h3>
                <table class="grid">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>

                        <tr>
                            <td class="required">Configuration</td>
                            <td>The name of an existing configuration which holds all the connection information for the Kubernetes cluster.</td>
                        </tr>

                        <tr class="required">
                            <td>Kubernetes API URI</td>
                            <td>The URI for the Kubernetes API to invoke. E.g., '/api/v1/namespaces'.</td>
                        </tr>

                        <tr class="required">
                            <td>HTTP method for the Kubernetes API</td>
                            <td>HTTP method for the Kubernetes REST API to be invoked.</td>
                        </tr>

                        <tr>
                            <td>Request Payload Format</td>
                            <td>Format of the request payload. Possible values are 'json' or 'yaml'. Not applicable for HTTP methods 'get' and 'delete'.</td>
                        </tr>

                        <tr>
                            <td>Request Payload</td>
                            <td>The request body/payload in JSON or YAML format. Not applicable for HTTP methods 'get' and 'delete'.</td>
                        </tr>

                        <tr>
                            <td>Output Property Location</td>
                            <td>Location of the output property where the API response will be saved. If not specified, then if the procedure is invoked in a pipeline, the location will default to '/myStageRuntime/k8sAPIResult' else it will default to '/myJob/k8sAPIResult'.</td>
                        </tr>

                    </tbody>
                </table>

            </div>

            <h1 id="usecases">Use Cases</h1>
            <div id="RollingUpdates">
                <h2>Rolling Updates</h2>
                <p>Rolling updates or rolling deployment is a way to deploy a new version with zero downtime by incrementally updating instances running an old version with the new one. In Kubernetes, this is done using rolling updates which allows a <i>Deployment's</i> update to take place by incrementally updating pods with new ones.</p>
                <p>EC-Kubernetes plugin deploys services using rolling updates by default. When ElectricFlow deploys a service to Kubernetes, the EC-Kubernetes plugin uses the following service attributes for the <i>Deployment</i>'s rolling update attributes in Kubernetes.</p>
                <p>
                    <ol>
                        <li><b>Rolling Deployment - Min Microservice Instances: </b>Minimum number of pods that must be running during a rolling update. Defaults to 1 if not set.</li>
                        <li><b>Rolling Deployment - Max Microservice Instances: </b>Maximum number of pods that can be running during a rolling update. The incremental number of pods that can be created during the rolling update is the difference between this attribute and the <b>Number of microservice instances</b>.</li>
                    </ol>
                </p>
                <p>
                    <img src="../../plugins/@PLUGIN_KEY@/images/RollingDeploymentAttributes.png" alt="screenshot" />
                </p>
            </div>
            <div id="CanaryDeployments">
                <h2>Canary Deployments</h2>
                <p>Canary deployment is a way of sending out a new release into production that plays the role of a "canary" to get an idea of how a new release will perform before rolling it out to all the users.</p>
                <p>A canary deployment consists of rolling out a new release or a new functionality to a subset of users or servers. This can be achieved in a Kubernetes cluster by deploying a canary of a new release side by side with the previous release so that the new release can receive live production traffic before fully rolling it out. (Reference: <a href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments" target="_blank">Canary Deployments</a>).</p>
                <p>When ElectricFlow deploys a service to Kubernetes, the EC-Kubernetes plugin manages both the service in Kubernetes (the abstraction for a logical set of pods and a policy by which to access them) as well as the deployment controller (a deployment controller provides declarative updates for pods and replicate sets). The service created or updated by the plugin is configured to point to the pods created based on the pod specifications declared in the deployment controller.
                    In order to perform a canary deployment, the following two service mapping attributes can be set:<br/>
                    <ol>
                        <li><b>Perform Canary Deployment: </b>If true, then a canary deployment will be performed. Any previous deployment will remain unchanged in the namespace allowing this canary deployment to receive live traffic side by side with the previous deployment.</li>
                        <li><b>Number of Canary Replicas: </b>The number of replicas to create if performing a canary deployment. Defaults to 1 replica for the canary deployment.</li>
                    </ol>
                    <br/>Having these attributes in the service mapping allows you to use the same service deployment and undeployment processes that you would use for performing a more typical service deployment or undeployment. The following steps describe how this can be achieved.
                    <ol>
                        <li>Set <i>$[/myJob/canaryDeployment]</i> as the property reference value for <b>Perform Canary Deployment</b> and <i>$[/myJob/canaryReplicas]</i> for <b>Number of Canary Replicas</b>.<br/>
                            <img src="../../plugins/@PLUGIN_KEY@/images/CanaryDeploymentServiceAttributes.png" alt="screenshot" /><br/><br/></li>
                        <li>Now add <i>canaryDeployment</i> and <i>canaryReplicas</i> as parameters to your service or application deploy and the undeploy processes.<br/>The values specified for these parameters will automatically be resolved when the service mapping is used by EC-Kubernetes while performing the deployment. If <i>canaryDeployment</i> is set to true, then a canary deployment will be performed.<br/>
                            <img src="../../plugins/@PLUGIN_KEY@/images/CanaryDeploymentDeployProcessParameters.png" alt="screenshot" /><br/>
                            Similarly, during undeploy process through <i>Undeploy Service</i> procedure, if <i>canaryDeployment</i> is set to true, then the canary deployment will be removed without impacting the previous deployment or the service.
                            <img src="../../plugins/@PLUGIN_KEY@/images/CanaryDeploymentUndeployProcessParameters.png" alt="screenshot" /><br/><br/>
                        </li>
                        <li>Finally tie the deploy and undeploy processes into an end-to-end service release pipeline including managing the canary deployments and rolling out new releases.<br/>
                            <img src="../../plugins/@PLUGIN_KEY@/images/CanaryDeploymentPipeline.png" alt="screenshot" /><br/>
                            <p>(1) Define a 'deploy canary' task to perform a canary deployment using the specified version on the same environment where the service is targeted.<br/>
                            (2) After the canary deployment is pushed out to the environment, side by side with the previous release, use a manual task to approve the roll out of the new version if it is confirmed that the 'canary deployment is safe' and good to be rolled out.<br/>
                            (3) Once the canary deployment is confirmed to be safe and the pipeline is allowed to continue, define a 'deploy new service version' task to deploy the new version of the service.<br/>
                            (4) Finally, regardless of the canary deployment's result, define an 'undeploy the canary' task to undeploy the canary deployment.<br/>
                            </p>
                        </li>
                    </ol>

                </p>
            </div>
            <div id="BlueGreenDeployments">
                <h2>Blue/Green Deployments</h2>
                <p>Blue/green deployments allow us to deploy 2 versions of an application, the current version and the next to an environment and switch seamlessly between them with zero downtime for the application.</p>
                <p>A blue/green deployment can be achieved in Kubernetes by creating a new deployment, say <i>my-deployment-green</i> for running the new version while all the old pods created earlier for the older deployment, say <i>my-deployment-blue</i> are still serving all the live requests. Once the new deployment has completed successfully, and has optionally been tested through a test service, then the service in Kubernetes is switched to send requests to the newly created pods running the new version.</p>
                <p>When ElectricFlow deploys a service to Kubernetes, the EC-Kubernetes plugin manages both the service in Kubernetes (the abstraction for a logical set of pods and a policy by which to access them) as well as the deployment controller (a deployment controller provides declarative updates for pods and replicate sets). The service created or updated by the plugin is configured to point to the pods created based on the pod specifications declared in the deployment controller.
                <br/>In order to orchestrate a blue/green deployment, the following two service mapping attributes can be leveraged:<br/>
                <ol>
                    <li><b>Service Name Override: </b>Name for the service in Kubernetes. If no override value is specified, the service name in ElectricFlow will be used to name the service in Kubernetes.</li>
                    <li><b>Deployment Name Override: </b>Name for the deployment in Kubernetes. If no value is specified, then the name of the Kubernetes service being created or updated will be used to name the deployment in Kubernetes.</li>
                </ol>
                <br/>Having these attributes in the service mapping allows you to use the same service deployment and undeployment processes that you would use for performing a more typical service deployment or undeployment. The following steps describe how a blue/green deployment can be orchestrated using the two service mapping attributes mentioned above.

                <ol>
                    <li>Set <i>$[/myJob/serviceNameOverride]</i> as the property reference value for <b>Service Name Override</b> and <i>$[/myJob/deploymentNameOverride]</i> for <b>Deployment Name Override</b>.<br/>
                        <img src="../../plugins/@PLUGIN_KEY@/images/BlueGreenDeploymentServiceAttributes.png" alt="screenshot" /><br/><br/></li>
                    <li>Now add <i>serviceNameOverride</i> and <i>deploymentNameOverride</i> as parameters to your service or application deploy and the undeploy processes.<br/>The values specified for these parameters will automatically be resolved when the service mapping is used by EC-Kubernetes while performing the deployment. We will use different combination of values for these two parameters to do a blue/green deployment next.<br/>
                        <img src="../../plugins/@PLUGIN_KEY@/images/BlueGreenDeploymentDeployProcessParameters.png" alt="screenshot" /><br/><br/>
                        Similarly, we will use different combination of values for these two parameters when undeploying the service.<br/>
                        <img src="../../plugins/@PLUGIN_KEY@/images/BlueGreenDeploymentUndeployProcessParameters.png" alt="screenshot" /><br/><br/>
                        <i>Note that the processes also have a parameter defined for passing in the container image version to use when deploying the service.</i><br/><br/>
                    </li>
                    <li>Now that the basic building blocks are in place, lets deploy the very first version of the service with no value set for <i>serviceNameOverride</i> and <i>deploymentNameOverride</i> set to say 'my-deployment-v1', where v1 is the image version number. This becomes the 'blue' deployment or the version that is currently deployed. Now, for any new version that is to be deployed for the service, the deployment pipeline should include the following tasks in order to orchestrate a blue/green deployment:<br/>
                        <img src="../../plugins/@PLUGIN_KEY@/images/BlueGreenDeploymentPipeline.png" alt="screenshot" /><br/>
                        <p>(1) Create an environment snapshot for the application or the microservice to capture deployment details for the service such as the current version deployed.<br/>
                            (2) Now define a task for the 'green' deployment using the new version to create a deployment for. Use the service name override so that a new deployment is created in kubernetes as well as a new service end-point. The new service end-point can be used to access the 'green' deployment in order to perform any final tests or verification if required.<br/>
                            (3) Now, create another task for the deploy process, this time using the deployment name override but not the service name override. This will result in the original service's selector to be updated to target the pods created through the new deployment.<br/>
                            (4) Finally, define a 'cleanup blue deployment' task to undeploy the original 'blue' deployment as well as the new service end point by specifying both the service name override value and the deployment name override value.<br/>
                        </p>
                    </li>
                </ol>
            </p>
            </div>

            <h1 id="releaseNotes">Release Notes</h1>
            <h3>EC-Kubernetes 1.0.5</h3>
            <ul>
                <li>All leading and trailing whitespaces in service mapping parameters such as <i>canaryDeployment</i> will be removed before the parameter value is used.</li>
            </ul>
            <h3>EC-Kubernetes 1.0.4</h3>
            <ul>
                <li>Added a validation check in procedure <i>Deploy Service</i> to ensure that the user-specified container port names within a service are unique.</li>
                <li>When deploying a microservice through ElectricFlow on a Kubernetes cluster, the EC-Kubernetes plugin will now monitor the deployment progress in Kubernetes and cause the step to fail
                    in case the deployment does not complete within the deployment timeout configured as part of the service mapping. The default timeout value is 120 seconds.</li>
                <li>When deploying a microservice through ElectricFlow on a Kubernetes cluster, the deployment name to use in Kubernetes can now be overridden through the service mapping. See section <a href="#BlueGreenDeployments">Blue/Green Deployments</a> for details on how this ability can be used to implement a blue/green deployment strategy.</li>
            </ul>
            <h3>EC-Kubernetes 1.0.3</h3>
            <ul>
                <li>Made secrets compliant with DNS-1123 standards.</li>
                <li>Removed unused parameter <i>additionalAttributes</i> from container mapping configuration.</li>
                <li>When a microservice is deployed through ElectricFlow on a Kubernetes cluster, and 'NodePort' is specified as the service type in the service mapping, then the provisioned node port is registered as a pipeline stage runtime property <i>/myStageRuntime/&lt;applicationName&gt;/&lt;serviceName&gt;/&lt;targetPort&gt;/nodePort</i>.</li>
                <li>When deploying a microservice through ElectricFlow on a Kubernetes cluster, the service name to use in Kubernetes can now be overridden through the service mapping.</li>
                <li>Deprecated procedure <i>Create Resource</i>. The newly added procedure <i>Invoke Kubernetes API</i> should be used instead for creating or updating a Kubernetes resource.</li>
                <li>Added support for <b>canary deployments</b>. See section <a href="#CanaryDeployments">Canary Deployments</a> for details.</li>
            </ul>
            <h3>EC-Kubernetes 1.0.2</h3>
            <ul>
                <li>Added support for Kubernetes API version 1.7</li>
                <li>Added 'kubernetesVersion' parameter in the plugin configuration to allow the user to identify the Kubernetes version running on the cluster master. The parameter will default to '1.6' if no value is specified.</li>
                <li>Added procedure <i>Undeploy Service</i> to undeploy a previously deployed service.</li>
                <li>Handled race condition in parallel creation of a namespace by multiple steps.</li>
            </ul>
            <h3>EC-Kubernetes 1.0.1</h3>
            <ul>
                <li>Added helper functions in base client utility to support services Discovery in EC-GoogleContainerEngine</li>
            </ul>
            <h3>EC-Kubernetes 1.0.0</h3>
            <ul>
                <li>First release.</li>
            </ul>
        </div>
    </body>
</html> 
